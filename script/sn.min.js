$(function(){var $this;return $this={init:function(options){return null==options&&(options={}),$(this).sn("setup",options),$(this).sn("start")},setup:function(options){var sn;return null==options&&(options={}),window.sn={},sn={levels:{},users:{},content:{},conf:{},result:{},theme:{},settings:{}},$.extend(!0,sn,options),$(this).data("sn",sn),sn},start:function(options){return null==options&&(options={}),"undefined"!=typeof console&&null!==console&&console.log("configuration..."),$(this).snConf(),"undefined"!=typeof console&&null!==console&&console.log("autoload..."),$(this).snEvents("#autoload")}},$.fn.sn=function(sn){return null==sn&&(sn={}),$this[sn]?$this[sn].apply(this,Array.prototype.slice.call(arguments,1)):$this.init.apply(this,arguments)}}),$(function(){var $this;return $this={init:function(options){null==options&&(options={})},settings:function(){var sn;return sn=$(this).data("sn"),"undefined"!=typeof console&&null!==console&&console.log("conf: settings.json"),$.ajax({url:"conf/settings.json",async:!1,dataType:"json",success:function(s){return null!=s&&($.extend(sn.settings,s),sn.settings.enable=!0,sn.conf.settings=!0),$(this).data("sn",sn)}})}},$.fn.snConf=function(sn){return null==sn&&(sn={}),$this[sn]?$this[sn].apply(this,Array.prototype.slice.call(arguments,1)):$this.init.apply(this,arguments)}}),$(function(){var $this;return $this={init:function(options){var def,href,levels;if(null==options&&(options={}),def={href:"#autoload"},"object"!=typeof options?href=options:($.extend(!0,def,options),href=def.href),"#"!==href&&href.match(/#([a-zA-Z0-9\_\-]+)/)&&(levels={one:href.match(/#([a-zA-Z0-9\_\-]+)/,"$2"),two:href.match(/#[a-zA-Z0-9\_\-]+\/([a-zA-Z0-9\_\-]+)/,"$3"),three:href.match(/#[a-zA-Z0-9\_\-]+\/[a-zA-Z0-9\_\-]+\/([a-zA-Z0-9\_\-]+)/,"$4"),anchor:href.match(/\:([a-zA-Z0-9\_\-]+)/)},"undefined"!=typeof console&&null!==console&&console.info("url: "+href),"undefined"!=typeof console&&null!==console&&console.info("levels: ",levels),null!=levels.one&&"spoiler"!==levels.one[1])){switch(levels.one[1]){case"autoload":$(this).snMaps(),$(this).snUsers();break;default:null!=levels.two&&null!=levels.three&&(window.sn.part=levels.one[1])}return $(this).click(levels)}}},$.fn.snEvents=function(sn){return null==sn&&(sn={}),$this[sn]?$this[sn].apply(this,Array.prototype.slice.call(arguments,1)):$this.init.apply(this,arguments)}}),$(function(){var $this;return $this={init:function(options){null==options&&(options={})},spoiler:function(){return"undefined"!=typeof console&&null!==console&&console.log("trigger: spoiler"),$(this).find(".spoiler-caption").on("click",function(e){return e.preventDefault(),$(this).hasClass("spoiler-open")?$(this).removeClass("spoiler-open").addClass("spoiler-close"):$(this).removeClass("spoiler-close").addClass("spoiler-open"),$(this).parent(".spoiler").children(".spoiler-body").each(function(){return $(this).hasClass("spoiler-open")?$(this).removeClass("spoiler-open").addClass("spoiler-close").hide():$(this).removeClass("spoiler-close").addClass("spoiler-open").show()})})}},$.fn.snTriggers=function(sn){return null==sn&&(sn={}),$this[sn]?$this[sn].apply(this,Array.prototype.slice.call(arguments,1)):$this.init.apply(this,arguments)}}),$(function(){var $this;return $this={init:function(options){var _this;return null==options&&(options={}),_this=this,ymaps.ready(function(){var clusterer,map,placemarks;return map=new ymaps.Map("map",{center:[56.840001,53.239778],zoom:12,behaviors:["default","scrollZoom"]}),map.options.set("scrollZoomSpeed",4),map.controls.add("zoomControl"),map.controls.add("typeSelector"),map.controls.add("mapTools"),clusterer=new ymaps.Clusterer,placemarks=[],map.events.add("click",function(event){var coordinates,_ref,_ref1,_ref2;return null!=(null!=(_ref=window.user)?_ref.id:void 0)&&null!=(null!=(_ref1=window.user)?_ref1.login:void 0)&&null!=(null!=(_ref2=window.user)?_ref2.hash:void 0)?(coordinates=event.get("coordPosition"),map=event.get("target"),$("#modal-newmark").modal(),$(".newmark-add-link").off("click"),$(".newmark-add-link").on("click",function(e){return e.preventDefault(),$(_this).snMapsAjax("addNewMark",coordinates,$(this).data("vid"),function(res){var placemark;return res?("undefined"!=typeof console&&null!==console&&console.info("add",res),placemark=$(_this).snMapsPlacemark(ymaps,res),map.geoObjects.add(placemark)):alert("К сожалению, не удалось добавить метку на карту")})})):void 0}),$(_this).snMapsAjax("getPoints",function(points){var i,point;for(i in points)point=points[i],null!=point.POINT&&(placemarks[i]=$(_this).snMapsPlacemark(ymaps,point),map.geoObjects.add(placemarks[i]));return clusterer.options.set({gridSize:100,maxZoom:16,minClusterSize:2})})})}},$.fn.snMaps=function(sn){return null==sn&&(sn={}),$this[sn]?$this[sn].apply(this,Array.prototype.slice.call(arguments,1)):$this.init.apply(this,arguments)}}),$(function(){var $this;return $this={getPoints:function(callback){return $.ajax({url:"index.php",type:"GET",data:{action:"getPoints"},dataType:"json",success:function(s){return null!=s.points&&null!=callback?callback(s.points):void 0},error:function(XMLHttpRequest,textStatus,error){return"undefined"!=typeof console&&null!==console?console.log(XMLHttpRequest,textStatus,error):void 0}})},getBalloonContent:function(uuid,callback){var _ref,_ref1,_ref2;return null!=uuid?$.ajax({url:"index.php",type:"GET",data:{action:"getBalloonContent",uuid:uuid,userid:null!=(null!=(_ref=window.user)?_ref.id:void 0)?window.user.id:"",login:null!=(null!=(_ref1=window.user)?_ref1.login:void 0)?window.user.login:"",hash:null!=(null!=(_ref2=window.user)?_ref2.hash:void 0)?window.user.hash:""},dataType:"json",success:function(s){return"undefined"!=typeof console&&null!==console&&console.info(s),null!=s.content&&null!=s.agents&&null!=s.signin&&null!=callback?callback(s):void 0},error:function(XMLHttpRequest,textStatus,error){return"undefined"!=typeof console&&null!==console?console.log(XMLHttpRequest,textStatus,error):void 0}}):void 0},addNewMark:function(coordinates,vid_id,callback){var _ref,_ref1,_ref2;return null!=coordinates&&null!=vid_id?$.ajax({url:"index.php",type:"GET",data:{action:"addNewMark",lat:coordinates[0],lon:coordinates[1],vid:vid_id,userid:null!=(null!=(_ref=window.user)?_ref.id:void 0)?window.user.id:"",login:null!=(null!=(_ref1=window.user)?_ref1.login:void 0)?window.user.login:"",hash:null!=(null!=(_ref2=window.user)?_ref2.hash:void 0)?window.user.hash:""},dataType:"json",success:function(s){return null!=s.res&&null!=callback?callback(s.res):void 0},error:function(XMLHttpRequest,textStatus,error){return"undefined"!=typeof console&&null!==console?console.log(XMLHttpRequest,textStatus,error):void 0}}):void 0},removeMark:function(uuid,callback){var _ref,_ref1,_ref2;return null!=uuid?$.ajax({url:"index.php",type:"GET",data:{action:"removeMark",uuid:uuid,userid:null!=(null!=(_ref=window.user)?_ref.id:void 0)?window.user.id:"",login:null!=(null!=(_ref1=window.user)?_ref1.login:void 0)?window.user.login:"",hash:null!=(null!=(_ref2=window.user)?_ref2.hash:void 0)?window.user.hash:""},dataType:"json",success:function(s){return"undefined"!=typeof console&&null!==console&&console.info(s),null!=s.res&&null!=callback?callback(s.res):void 0},error:function(XMLHttpRequest,textStatus,error){return"undefined"!=typeof console&&null!==console?console.log(XMLHttpRequest,textStatus,error):void 0}}):void 0},saveMark:function(uuid,values,callback){var _ref,_ref1,_ref2;return null!=uuid&&null!=values?$.ajax({url:"index.php",type:"GET",data:{action:"saveMark",uuid:uuid,agent:values.agent,info:values.info,date1:values.date1,date2:values.date2,lat:values.lat,lon:values.lon,userid:null!=(null!=(_ref=window.user)?_ref.id:void 0)?window.user.id:"",login:null!=(null!=(_ref1=window.user)?_ref1.login:void 0)?window.user.login:"",hash:null!=(null!=(_ref2=window.user)?_ref2.hash:void 0)?window.user.hash:""},dataType:"json",success:function(s){return null!=s.res&&null!=callback?callback(s.res):void 0},error:function(XMLHttpRequest,textStatus,error){return"undefined"!=typeof console&&null!==console?console.log(XMLHttpRequest,textStatus,error):void 0}}):void 0},dragMark:function(uuid,coordinates,callback){var _ref,_ref1,_ref2;return null!=uuid&&null!=coordinates?$.ajax({url:"index.php",type:"GET",data:{action:"dragMark",uuid:uuid,lat:coordinates[0],lon:coordinates[1],userid:null!=(null!=(_ref=window.user)?_ref.id:void 0)?window.user.id:"",login:null!=(null!=(_ref1=window.user)?_ref1.login:void 0)?window.user.login:"",hash:null!=(null!=(_ref2=window.user)?_ref2.hash:void 0)?window.user.hash:""},dataType:"text",success:function(s){return"undefined"!=typeof console&&null!==console&&console.info(s),null!=s.res&&null!=callback?callback(s.res):void 0},error:function(XMLHttpRequest,textStatus,error){return"undefined"!=typeof console&&null!==console?console.log(XMLHttpRequest,textStatus,error):void 0}}):void 0}},$.fn.snMapsAjax=function(sn){return null==sn&&(sn={}),$this[sn]?$this[sn].apply(this,Array.prototype.slice.call(arguments,1)):void 0}}),$(function(){var $this;return $this={init:function(ymaps,point){var placemark,_this;return _this=this,placemark=new ymaps.Placemark($this.coordinates(point),$this.properties(point),$this.options(point)),placemark=$this.onBalloonOpen(placemark),placemark=$this.onDragEnd(placemark)},coordinates:function(point){var coordinates,coords;return coords=(""+point.POINT).replace(/[\s\[\]]/g,""),coordinates=[coords.replace(/^(.*)\,(.*)$/,"$1"),coords.replace(/^(.*)\,(.*)$/,"$2")]},properties:function(point){return{hintContent:null!=point.PLAN_PERIOD_END?"до <b>"+(""+point.PLAN_PERIOD_END)+"</b>":void 0,balloonContentHeader:"<div>"+point.SVID+"</div>",balloonContentBody:"",uuid:""+point.D$UUID}},options:function(point){var _ref,_ref1,_ref2;return{balloonMinWidth:350,balloonMinHeight:200,preset:"0"===point.VID_ID?"twirl#workshopIcon":"twirl#turnRightIcon",draggable:(null!=(_ref=point.USER_ID)?""+_ref:void 0)===(null!=(_ref1=window.user)?null!=(_ref2=_ref1.id)?""+_ref2:void 0:void 0)?!0:!1}},onBalloonOpen:function(placemark){var _this;return _this=this,placemark.events.add("balloonopen",function(e){var balloon,map,uuid;return placemark=e.get("target"),balloon=e.get("balloon"),map=placemark.getMap(),uuid=""+placemark.properties.get("uuid"),$(_this).snMapsAjax("getBalloonContent",uuid,function(res){var _ref,_ref1,_ref2,_ref3;return res.signin&&(null!=(_ref=window.user)?null!=(_ref1=_ref.id)?""+_ref1:void 0:void 0)===(null!=(_ref2=res.content)?null!=(_ref3=_ref2.USER_ID)?""+_ref3:void 0:void 0)?(res.coordinates=$this.coordinates(res.content),placemark.options.set("balloonMinWidth",500),placemark.options.set("balloonMinHeight",400),placemark.properties.set("balloonContentBody",new EJS({url:"view/balloonContentEditor.html",ext:".html",type:"[",cache:!1}).render(res)),$("#dp1").datepicker(),$("#dp2").datepicker(),$(".mark-delete-link").on("click",function(e){return e.preventDefault(),$(_this).snMapsAjax("removeMark",uuid,function(response){return response?map.geoObjects.remove(placemark):alert("К сожалению, не удалось удалить метку")})}),$(".mark-save-link").on("click",function(e){var coordinates;return e.preventDefault(),coordinates=[$("#lat").val(),$("#lon").val()],placemark.geometry.setCoordinates(coordinates),$(_this).snMapsAjax("saveMark",uuid,{agent:$("#agent").val(),info:$("#info").val(),date1:$("#date1").val(),date2:$("#date2").val(),lat:$("#lat").val(),lon:$("#lon").val()},function(response){return response?void 0:alert("К сожалению, не удалось сохранить метку")})}),$(".balloon-close").on("click",function(e){return e.preventDefault(),balloon.close()})):placemark.properties.set("balloonContentBody",new EJS({url:"view/balloonContent.html",ext:".html",type:"[",cache:!1}).render(res))})}),placemark},onDragEnd:function(placemark){var _this;return _this=this,placemark.events.add("dragend",function(e){var coordinates,uuid;return placemark=e.get("target"),coordinates=placemark.geometry.getCoordinates(),null!=coordinates&&console.info(coordinates),uuid=""+placemark.properties.get("uuid"),$(_this).snMapsAjax("dragMark",uuid,coordinates)}),placemark}},$.fn.snMapsPlacemark=function(sn){return null==sn&&(sn={}),$this[sn]?$this[sn].apply(this,Array.prototype.slice.call(arguments,1)):$this.init.apply(this,arguments)}}),$(function(){var $this;return $this=$.fn.snMapsTriggers=function(sn){return null==sn&&(sn={}),$this[sn]?$this[sn].apply(this,Array.prototype.slice.call(arguments,1)):void 0}}),$(function(){var $this;return $this={init:function(options){return null==options&&(options={}),$(this).snUsersTriggers("signinFormSubmit")},afterSignin:function(res){return null==res&&(res={}),res.signin&&null!=res.signin.id&&null!=res.signin.login&&null!=res.signin.hash?(window.user={id:res.signin.id,login:res.signin.login,hash:res.signin.hash},$.cookie("user_id",res.signin.id,{expires:365}),$.cookie("user_login",res.signin.login,{expires:365}),$.cookie("user_hash",res.signin.hash,{expires:365})):void 0},exit:function(){return null!=window.user&&(window.user={}),$.removeCookie("user_id"),$.removeCookie("user_login"),$.removeCookie("user_hash")}},$.fn.snUsers=function(sn){return null==sn&&(sn={}),$this[sn]?$this[sn].apply(this,Array.prototype.slice.call(arguments,1)):$this.init.apply(this,arguments)}}),$(function(){var $this;return $this={signin:function(data,callback){return $.ajax({url:"index.php",type:"GET",data:{action:"signin",login:null!=data.login?data.login:"",password:null!=data.password?data.password:"",hash:null!=data.hash?data.hash:""},dataType:"json",success:function(s){return null!=s&&null!=callback?callback(s):void 0},error:function(XMLHttpRequest,textStatus,error){return"undefined"!=typeof console&&null!==console?console.log(XMLHttpRequest,textStatus,error):void 0}})}},$.fn.snUsersAjax=function(sn){return null==sn&&(sn={}),$this[sn]?$this[sn].apply(this,Array.prototype.slice.call(arguments,1)):void 0}}),$(function(){var $this,_this;return _this=this,$.cookie(true&&$.cookie(true))&&$(_this).snUsersAjax("signin",{login:$.cookie("user_login"),hash:$.cookie("user_hash")},function(res){return null!=res.signin&&($(_this).snUsers("afterSignin",res),res.signin)?($(".signin-exit-link").parent("li").show(),$(".signin-enter-link").parent("li").hide()):void 0}),$this={signinFormSubmit:function(options){return null==options&&(options={}),_this=this,$("#signin-form").on("submit",function(e){return e.preventDefault(),$(".signin-alert").hide(),$(_this).snUsersAjax("signin",{login:$("#signin-login").val(),password:$("#signin-password").val()},function(res){return null!=res.signin?($(_this).snUsers("afterSignin",res),res.signin?($("#signin-form").hide(),$(".signin-exit-link").parent("li").show(),$(".signin-enter-link").parent("li").hide(),$(".signin-alert-success").show(),setTimeout(function(){return $("#modal-signin").modal("hide")},500)):($(".signin-alert-error").show(),$("#signin-password").val(""))):void 0})}),$(".signin-enter-link").on("click",function(e){return e.preventDefault(),$("#signin-login").val(""),$("#signin-password").val(""),$(".signin-alert").hide()}),$(".signin-exit-link").on("click",function(e){return e.preventDefault(),$(".signin-exit-link").parent("li").hide(),$(".signin-enter-link").parent("li").show(),$("#signin-form").show(),$(".signin-alert").hide(),$("#signin-password").val(""),$(_this).snUsers("exit")})}},$.fn.snUsersTriggers=function(sn){return null==sn&&(sn={}),$this[sn]?$this[sn].apply(this,Array.prototype.slice.call(arguments,1)):void 0}});